{"code": "#ifdef GL_ES\nprecision mediump float;\n#endif\n\nuniform float time;\nuniform vec2 mouse;\nuniform vec2 resolution;\nuniform sampler2D iChannel0, iChannel1, bb;\n\nvarying vec2 surfacePosition;\nvarying vec2 surfaceSize;\n\n// shader port of kali's awesome work , for study and messing about with\n//   \n// \"Ancient Temple\" by Kali\n// https://www.shadertoy.com/view/4lX3Rj\n//\n// Made in \"messy coder\" mode, sorry! :D\n// I will clean up and comment later...\n\nconst int Iterations=36;\nconst float detail=.00002;\nconst float Scale=2.;\n\nvec3 lightdir=normalize(vec3(.15,.5,-1.));\n\n//float ot=0.;\nfloat det=0.;\n\nfloat hitfloor;\n\nfloat de(vec3 pos) {\n\thitfloor=0.;\n\tvec3 p=pos;\n\tp.xz=abs(.5-mod(pos.xz,1.))+.01;\n\tfloat DEfactor=1.;\n\t//ot=100.;\n\tfor (int i=0; i<Iterations; i++) {\n\t\tp = abs(p)-vec3(0.,2.,0.);  \n\t\tfloat r2 = dot(p, p-0.12);\n\t\t//ot = min(ot,abs(length(p)));\n\t\tfloat sc=Scale/clamp(r2,0.4,1.);\n\t\tp*=sc; \n\t\tDEfactor*=sc;\n\t\tp = p - vec3(0.5,1.,0.5);\n\t}\n\tfloat fl=pos.y-3.013;\n\tfloat d=min(fl,length(p)/DEfactor-.0005);\n\td=min(d,-pos.y+3.9);\n\tif (abs(d-fl)<.0001) hitfloor=1.;\n\treturn d;\n}\n\n\n\nvec3 normal(vec3 p) {\n\tvec3 e = vec3(0.0,det,0.0);\n\tfloat dep = de(p);\n\treturn normalize(vec3(\n\t\t\tde(p+e.yxx)-dep,\n\t\t\tde(p+e.xyx)-dep,\n\t\t\tde(p+e.xxy)-dep));\t\n}\n\nfloat shadow(vec3 pos, vec3 sdir) {\n\tfloat totalDist =2.0*det, sh=1.;\n \tfor (int steps=0; steps<30; steps++) \n\t\tif (totalDist<1.) {\n\t\t\tvec3 p = pos - totalDist * sdir;\n\t\t\tfloat dist = de(p)*1.5;\n\t\t\tif (dist < detail)  sh=0.;\n\t\t\ttotalDist += max(0.05,dist);\n\t\t}\n\treturn max(0.,sh);\t\n}\n\nfloat calcAO( const vec3 pos, const vec3 nor ) {\n    float aodet=detail*80.;\n    float totao = 0.0;\n    float sca = 10.0;\n    for( int aoi=0; aoi<5; aoi++ ) {\n        float hr = aodet + aodet*float(aoi*aoi);\n        vec3 aopos =  nor * hr + pos;\n        float dd = de( aopos );\n        totao += -(dd-hr)*sca;\n        sca *= 0.75;\n    }\n    return clamp( 1.0 - 5.0*totao, 0.0, 1.0 );\n}\n\nfloat kset(vec3 p) {\n\tp=abs(.5-fract(p*20.));\n\tfloat es, l=es=0.;\n\tfor (int i=0;i<13;i++) {\n\t\tfloat pl=l;\n\t\tl=length(p);\n\t\tp=abs(p)/dot(p,p)-.5;\n\t\tes+=exp(-1./abs(l-pl));\n\t}\n\treturn es;\t\n}\n\nvec3 light(in vec3 p, in vec3 dir) {\n\tfloat hf=hitfloor;\n\tvec3 n=normal(p);\n\tfloat sh=min(1.,shadow(p, lightdir)+hf);\n\t//float sh=1.;\n\tfloat ao=calcAO(p,n);\n\tfloat diff=max(0.,dot(lightdir,-n))*sh*1.3;\n\tfloat amb=max(0.2,dot(dir,-n))*.4;\n\tvec3 r = reflect(lightdir,n);\n\tfloat spec=pow(max(0.,dot(dir,-r))*sh,10.)*(.5+ao*.5);\n\tfloat k=kset(p)*.18; \n\tvec3 col=mix(vec3(k*1.1,k*k*1.3,k*k*k),vec3(k),.45)*2.;\n\tcol=col*ao*(amb*vec3(.9,.85,1.)+diff*vec3(1.,.9,.9))+spec*vec3(1,.9,.5)*.7;\t\n\treturn col;\n}\n\n\nvec3 raymarch(in vec3 from, in vec3 dir) \n{\n\tvec2 lig=vec2(sin(time*2.)*.6,cos(time)*.25-.25);\n\tfloat fog,glow,d=1., totdist=glow=fog=0.;\n\tvec3 p, col=vec3(0.);\n\tfloat ref=0.;\n\tfloat steps;\n\tfor (int i=0; i<130; i++) \n\t    if (d>det && totdist<3.5) {\n\t\tp=from+totdist*dir;\n\t\td=de(p);\n\t\tdet=detail*(1.+totdist*55.);\n\t\ttotdist+=d; \n\t\tglow+=max(0.,.02-d)*exp(-totdist);\n\t\tsteps++;\n\t    }\n\t\n\t//glow/=steps;\n\tfloat l=pow(max(0.,dot(normalize(-dir),normalize(lightdir))),10.);\n\tvec3 backg=vec3(.8,.85,1.)*.25*(2.-l)+vec3(1.,.9,.65)*l*.4;\n\tfloat hf=hitfloor;\n\tif (d<det) {\n\t\tcol=light(p-det*dir*1.5, dir); \n\t\tif (hf>0.5) col*=vec3(1.,.85,.8)*.6;\n\t\tcol*=min(1.2,.5+totdist*totdist*1.5);\n\t\tcol = mix(col, backg, 1.0-exp(-1.3*pow(totdist,1.3)));\n\t} else  col = backg;\n\t\n\tcol+=glow*vec3(1.,.9,.8)*.34;\n\tcol+=vec3(1,.8,.6)*pow(l,3.)*.5;\n\treturn col; \n}\n\nvoid main(void)\n{\n\tvec2 uv = gl_FragCoord.xy / resolution*2.-1.;\n\tuv.y *= resolution.y / resolution.x;\n\tvec2 mp = (mouse / resolution) - 1110.5;\n\tfloat y=(cos(time*.1)+1.);\n\t//if (iMouse.z<1.) mouse=vec2(sin(t*2.),cos(t)+.3)*.15*(.5+y)*min(1.,time*.1);\n\tuv += (mouse-0.5)*2.;\n\tuv.y-=.1;\n\t//uv+=(texture2D(iChannel1,vec2(time*.15)).xy-.5)*max(0.,h)*7.;\n\tvec3 from = vec3(0.0,3.04+y*.1,-2.+time*.05);\n\tvec3 dir = normalize(vec3(uv,1.));\n\tvec3 color = raymarch(from,dir); \n\t//col*=length(clamp((.6-pow(abs(uv2),vec2(3.))),vec2(0.),vec2(1.)));\n\tcolor*=vec3(0.5, 0.5, 0.4);\n\tcolor=pow(color,vec3(1.2));\n\tcolor=mix(vec3(length(color)),color,.85)*.95;\n\tcolor+=vec3(1,.85,.7)*pow(max(0.,.3-length(uv-vec2(0.,.03)))/.3,1.5)*.65;\n\tgl_FragColor = vec4(color,1.);\n}\n", "user": "504fce4", "parent": "/e#47386.0", "id": 47390}